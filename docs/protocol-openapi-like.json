{
  "openapi": "3.1.0",
  "info": {
    "title": "Oh-My-Agent UDS NDJSON Protocol",
    "version": "0.1.0",
    "description": "OpenAPI-style schema for command/response/event envelopes over UDS + NDJSON framing."
  },
  "x-transport": {
    "type": "uds",
    "framing": "ndjson"
  },
  "x-command-payload-requirements": {
    "ping": [],
    "prompt": ["text"],
    "steer": ["text"],
    "follow_up": ["text"],
    "abort": [],
    "set_active_tools": ["tools"],
    "set_steering_mode": ["mode"],
    "set_follow_up_mode": ["mode"],
    "get_state": [],
    "get_messages": [],
    "compact_session": [],
    "new_session": [],
    "switch_session": ["session_id"],
    "branch_session": ["session_id"],
    "extension_command": ["name"]
  },
  "x-command-payload-optional": {
    "prompt": ["wait", "leaf_id"],
    "steer": [],
    "follow_up": [],
    "abort": [],
    "compact_session": ["session_id", "instruction"]
  },
  "x-runtime-semantics": {
    "prompt": {
      "mode": "non_blocking_command",
      "behavior": "command response returns immediately; run lifecycle is delivered on event stream",
      "accepted_response": {
        "type": "accepted",
        "payload": {
          "command": "prompt",
          "run_id": "<run-id>"
        }
      },
      "legacy_compatibility": "sync result envelope may remain temporarily during migration"
    },
    "mid_run_controls": {
      "steer": "accepted during active run; injected with higher priority",
      "follow_up": "accepted during active run; queued after current convergence point",
      "abort": "accepted during active run; terminates run"
    }
  },
  "x-response-payload-requirements": {
    "pong": ["message"],
    "accepted:prompt": ["command", "run_id"],
    "accepted:steer": ["command", "run_id"],
    "accepted:follow_up": ["command", "run_id"],
    "accepted:abort": ["command", "run_id"],
    "accepted:set_active_tools": ["command"],
    "accepted:set_steering_mode": ["command", "mode"],
    "accepted:set_follow_up_mode": ["command", "mode"],
    "state": ["run_state", "run_id", "session_id", "steering_mode", "follow_up_mode", "pending_counts"],
    "messages": ["session_id", "messages"],
    "compaction": ["session_id", "summary", "first_kept_entry_id", "tokens_before", "trigger"],
    "result": ["output", "events", "session_id"],
    "session": ["session_id", "active"],
    "extension_result": []
  },
  "paths": {
    "/command": {
      "post": {
        "summary": "Send one command envelope",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/CommandEnvelope"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Command accepted",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ResponseEnvelope"
                }
              }
            }
          }
        }
      }
    },
    "/event": {
      "get": {
        "summary": "Read event envelopes",
        "responses": {
          "200": {
            "description": "Event stream",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/EventEnvelope"
                }
              }
            }
          }
        }
      }
    }
  },
  "components": {
    "schemas": {
      "EnvelopeBase": {
        "type": "object",
        "required": ["v", "id", "type", "payload"],
        "properties": {
          "v": { "type": "string", "const": "1" },
          "id": { "type": "string", "minLength": 1 },
          "type": { "type": "string", "minLength": 1 },
          "payload": { "type": "object" },
          "ts": { "type": "string" }
        }
      },
      "CommandEnvelope": {
        "allOf": [
          { "$ref": "#/components/schemas/EnvelopeBase" },
          {
            "type": "object",
            "properties": {
              "type": {
                "enum": [
                  "ping",
                  "prompt",
                  "steer",
                  "follow_up",
                  "abort",
                  "set_active_tools",
                  "set_steering_mode",
                  "set_follow_up_mode",
                  "get_state",
                  "get_messages",
                  "compact_session",
                  "new_session",
                  "switch_session",
                  "branch_session",
                  "extension_command"
                ]
              }
            }
          }
        ]
      },
      "ResponseEnvelope": {
        "allOf": [
          { "$ref": "#/components/schemas/EnvelopeBase" },
          {
            "type": "object",
            "required": ["ok"],
            "properties": {
              "ok": { "type": "boolean" },
              "error": {
                "type": "object",
                "required": ["code", "message"],
                "properties": {
                  "code": { "type": "string" },
                  "message": { "type": "string" },
                  "cause": { "type": "string" }
                }
              }
            }
          }
        ]
      },
      "EventEnvelope": {
        "allOf": [
          { "$ref": "#/components/schemas/EnvelopeBase" },
          {
            "type": "object",
            "properties": {
              "type": {
                "enum": [
                  "agent_start",
                  "agent_end",
                  "turn_start",
                  "turn_end",
                  "message_start",
                  "message_update",
                  "message_end",
                  "tool_execution_start",
                  "tool_execution_update",
                  "tool_execution_end",
                  "status",
                  "warning",
                  "error"
                ]
              }
            }
          }
        ]
      }
    }
  }
}
